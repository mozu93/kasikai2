
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šè­°å®¤äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .internal-room { background-color: #e0f2fe; } 
        .special-booking { background-color: #fef08a; color: #1f2937; /* yellow-200 and gray-800 */ }
        .today-highlight { background-color: #fce7f3 !important; /* pink-100 */ }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; /* 10% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 600px;
            border-radius: 8px;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex flex-col md:flex-row">
        <!-- Sidebar -->
        <aside class="w-full md:w-64 bg-white p-4 space-y-6">
            <div>
                <h2 class="text-lg font-bold mb-2">ä¼šè­°å®¤ã§çµã‚Šè¾¼ã‚€</h2>
                <div id="room-filter" class="space-y-2"></div>
            </div>
            <div>
                <h2 class="text-lg font-bold mb-2">å‡¡ä¾‹</h2>
                <div class="space-y-2">
                    <div class="flex items-center"><div class="w-4 h-4 mr-2" style="background-color: #fef08a; border: 1px solid #e5e7eb;"></div><span>ç„¡æ–™è²¸å‡º</span></div>
                    <div class="flex items-center"><div class="w-4 h-4 bg-blue-500 mr-2"></div><span>æœ‰æ–™è²¸å‡º</span></div>
                    <div class="flex items-center"><div class="w-4 h-4 bg-gray-300 mr-2"></div><span>ç©ºã</span></div>
                </div>
            </div>
            <div>
                <h2 class="text-lg font-bold mb-2">ğŸ“¤ CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                <div class="space-y-3 mb-6">
                    <div id="upload-container">
                        <input type="file" id="csv-file-input" accept=".csv" multiple class="hidden">
                        <button id="select-file-btn" class="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                            ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                        </button>
                        <div id="selected-file" class="mt-2 text-sm text-gray-600 hidden"></div>
                        <button id="upload-btn" class="w-full px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors mt-2 hidden">
                            ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
                        </button>
                    </div>
                    <div id="upload-status" class="text-sm"></div>
                    <div id="upload-progress" class="hidden">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†ãƒ‘ãƒãƒ« -->
            <div>
                <h2 class="text-lg font-bold mb-2">ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†</h2>
                <div class="space-y-3">
                    <!-- ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium">ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
                            <span id="server-status" class="px-2 py-1 text-xs rounded bg-green-200 text-green-800">èµ·å‹•ä¸­</span>
                        </div>
                        <div id="server-info" class="text-xs text-gray-600"></div>
                    </div>

                    <!-- è¨­å®šã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— -->
                    <div class="space-y-2">
                        <button id="open-config-btn" class="w-full px-3 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors">
                            âš™ï¸ ã‚«ã‚·ã‚«ã‚¤è¨­å®šã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼
                        </button>
                    </div>

                    <!-- ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ± -->
                    <div id="file-info" class="p-3 bg-gray-50 rounded-lg">
                        <div class="text-sm font-medium mb-2">ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ³</div>
                        <div id="file-status" class="text-xs text-gray-600 space-y-1"></div>
                    </div>

                    <!-- ã‚µãƒ¼ãƒãƒ¼åˆ¶å¾¡ -->
                    <div class="space-y-2">
                        <button id="refresh-status-btn" class="w-full px-3 py-2 bg-gray-500 text-white rounded text-sm hover:bg-gray-600 transition-colors">
                            ğŸ”„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                        </button>
                        <button id="stop-server-btn" class="w-full px-3 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors">
                            â¹ï¸ ã‚µãƒ¼ãƒãƒ¼åœæ­¢
                        </button>
                    </div>

                    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="admin-message" class="text-sm hidden"></div>
                </div>
            </div>
            
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8">
            <header class="mb-6">
                <h1 class="text-3xl font-bold text-gray-800">ä¼šè­°å®¤äºˆç´„çŠ¶æ³</h1>
            </header>

            <div class="bg-white p-4 rounded-lg shadow-md">
                <!-- æ“ä½œãƒ‘ãƒãƒ« -->
                <div class="mb-4">
                    <!-- ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ–ï¼ˆä¸Šæ®µï¼‰ -->
                    <div class="flex items-center space-x-2 mb-3">
                        <button id="month-view-btn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">æœˆ</button>
                        <button id="week-view-btn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">é€±</button>
                        <button id="day-view-btn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">æ—¥</button>
                    </div>
                    <!-- æœŸé–“ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹æ®µï¼‰ -->
                    <div class="flex items-center space-x-2">
                        <button id="prev-btn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&lt;</button>
                        <h2 id="current-period" class="text-xl font-semibold"></h2>
                        <button id="next-btn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&gt;</button>
                        <button id="today-btn" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">ä»Šæ—¥</button>
                    </div>
                </div>

                <!-- æ¤œç´¢ãƒ‘ãƒãƒ« -->
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="flex-1">
                            <input type="text" id="search-input" placeholder="æ¡ˆå†…è¡¨ç¤ºåã€äº‹æ¥­æ‰€åã€æ‹…å½“è€…åã€ãƒ¡ãƒ¢ãªã©å…¨é …ç›®ã‚’æ¤œç´¢..."
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button id="search-clear-btn" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 hidden">
                            ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                    <div id="search-results-count" class="text-sm text-gray-600 mt-2 hidden"></div>
                </div>

                <!-- æ¤œç´¢çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="search-results-container" class="hidden">
                    <h3 class="text-lg font-semibold mb-4">ğŸ” æ¤œç´¢çµæœ</h3>
                    <div id="search-results" class="space-y-3"></div>
                </div>

                <!-- ç©ºãçŠ¶æ³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="calendar-container" class="overflow-x-auto">
                    <div id="loading" class="text-center py-8">èª­ã¿è¾¼ã¿ä¸­...</div>
                    <div id="calendar"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Booking Detail Modal -->
    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold mb-4">äºˆç´„è©³ç´°</h2>
            <div id="modal-body" class="space-y-2"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = '/api/bookings';
            const CONFIG_URL = '/api/config';

            let rooms = {};
            let internalRoomIds = [];
            let modalFields = {};
            
            let bookings = [];
            let filteredRooms = [];
            let currentDate = new Date();
            let currentView = 'month'; // month, week, day
            let searchMode = false;
            let searchResultsData = [];

            const loadingEl = document.getElementById('loading');
            const calendarEl = document.getElementById('calendar');
            const currentPeriodEl = document.getElementById('current-period');
            const roomFilterEl = document.getElementById('room-filter');
            const modal = document.getElementById('booking-modal');
            const modalBody = document.getElementById('modal-body');
            const closeButton = document.querySelector('.close-button');

            // Search elements
            const searchInput = document.getElementById('search-input');
            const searchClearBtn = document.getElementById('search-clear-btn');
            const searchResultsCount = document.getElementById('search-results-count');
            const searchResultsContainer = document.getElementById('search-results-container');
            const searchResultsEl = document.getElementById('search-results');
            const calendarContainer = document.getElementById('calendar-container');
            
            // Upload elements
            const fileInput = document.getElementById('csv-file-input');
            const selectFileBtn = document.getElementById('select-file-btn');
            const selectedFileDiv = document.getElementById('selected-file');
            const uploadBtn = document.getElementById('upload-btn');
            const uploadStatus = document.getElementById('upload-status');
            const uploadProgress = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');

            // --- Modal Listeners ---
            closeButton.addEventListener('click', () => {
                modal.style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });

            // --- Event Listeners ---
            document.getElementById('prev-btn').addEventListener('click', () => moveDate(-1));
            document.getElementById('next-btn').addEventListener('click', () => moveDate(1));
            document.getElementById('today-btn').addEventListener('click', showToday);
            document.getElementById('month-view-btn').addEventListener('click', () => setView('month'));
            document.getElementById('week-view-btn').addEventListener('click', () => setView('week'));
            document.getElementById('day-view-btn').addEventListener('click', () => setView('day'));

            // Search event listeners
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(e.target.value);
                }, 300);
            });

            searchClearBtn.addEventListener('click', exitSearchMode);

            // ESCã‚­ãƒ¼ã§æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && searchMode) {
                    exitSearchMode();
                }
            });
            
            // --- Upload Event Listeners ---
            selectFileBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            uploadBtn.addEventListener('click', handleFileUpload);

            // --- Upload Functions ---
            function handleFileSelect(event) {
                const files = Array.from(event.target.files);
                if (files.length > 0) {
                    // CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿
                    const csvFiles = files.filter(file => 
                        file.name.toLowerCase().endsWith('.csv')
                    );
                    
                    if (csvFiles.length === 0) {
                        showUploadStatus('âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                        return;
                    }
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
                    const oversizedFiles = csvFiles.filter(file => file.size > 16 * 1024 * 1024);
                    if (oversizedFiles.length > 0) {
                        showUploadStatus('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ16MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰ã€‚', 'error');
                        return;
                    }
                    
                    if (csvFiles.length !== files.length) {
                        showUploadStatus('âš ï¸ CSVä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯é™¤å¤–ã•ã‚Œã¾ã—ãŸã€‚', 'warning');
                    }
                    
                    const totalSize = csvFiles.reduce((sum, file) => sum + file.size, 0);
                    const fileNames = csvFiles.map(f => f.name).join(', ');
                    selectedFileDiv.textContent = `ğŸ“„ é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ${csvFiles.length}å€‹ (åˆè¨ˆ: ${(totalSize / 1024).toFixed(1)} KB)\n${fileNames}`;
                    selectedFileDiv.classList.remove('hidden');
                    uploadBtn.classList.remove('hidden');
                    showUploadStatus('âœ… ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚', 'success');
                } else {
                    selectedFileDiv.classList.add('hidden');
                    uploadBtn.classList.add('hidden');
                    showUploadStatus('', 'info');
                }
            }
            
            function handleFileUpload() {
                console.log('handleFileUpload called, fileInput.files:', fileInput.files);
                const files = Array.from(fileInput.files).filter(file => 
                    file.name.toLowerCase().endsWith('.csv')
                );
                console.log('Filtered CSV files:', files);
                if (files.length === 0) {
                    showUploadStatus('âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
                    return;
                }
                
                const formData = new FormData();
                files.forEach((file, index) => {
                    formData.append('files', file);
                });
                
                // Progress bar ã‚’è¡¨ç¤º
                uploadProgress.classList.remove('hidden');
                progressBar.style.width = '0%';
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'ğŸ”„ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
                
                showUploadStatus('ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info');
                
                // Simulate progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 30;
                    if (progress > 90) progress = 90;
                    progressBar.style.width = progress + '%';
                }, 100);
                
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    
                    setTimeout(() => {
                        if (data.success) {
                            showUploadStatus(`âœ… ${data.message}`, 'success');
                            // Reset form
                            fileInput.value = '';
                            selectedFileDiv.classList.add('hidden');
                            uploadBtn.classList.add('hidden');
                            
                            // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆ1åˆ†å¾Œï¼‰
                            setTimeout(() => {
                                initialize();
                                showUploadStatus('ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚', 'success');
                            }, 61000); // 61ç§’å¾Œã«å†èª­ã¿è¾¼ã¿
                            
                        } else {
                            showUploadStatus(`âŒ ${data.error}`, 'error');
                        }
                        
                        uploadProgress.classList.add('hidden');
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ';
                    }, 500);
                })
                .catch(error => {
                    clearInterval(progressInterval);
                    console.error('Upload error:', error);
                    showUploadStatus('âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                    uploadProgress.classList.add('hidden');
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ';
                });
            }
            
            function showUploadStatus(message, type) {
                uploadStatus.textContent = message;
                uploadStatus.className = 'text-sm ';
                
                switch (type) {
                    case 'success':
                        uploadStatus.className += 'text-green-600';
                        break;
                    case 'error':
                        uploadStatus.className += 'text-red-600';
                        break;
                    case 'info':
                        uploadStatus.className += 'text-blue-600';
                        break;
                    default:
                        uploadStatus.className += 'text-gray-600';
                }
            }

            // --- Data Processing Functions ---
            function parseBookingData(rawBookings, config) {
                const processedBookings = [];
                
                rawBookings.forEach((booking, index) => {
                    // Skip cancelled bookings
                    if (booking['å–æ¶ˆæ—¥(äºˆç´„å†…å®¹)'] && booking['å–æ¶ˆæ—¥(äºˆç´„å†…å®¹)'].trim() !== '') {
                        return;
                    }
                    
                    // Parse date and time slot from åˆ©ç”¨æ—¥æ™‚(äºˆç´„å†…å®¹)
                    const bookingDateTime = booking['åˆ©ç”¨æ—¥æ™‚(äºˆç´„å†…å®¹)'];
                    if (!bookingDateTime) {
                        console.warn('Missing booking datetime:', booking);
                        return;
                    }
                    const dateTimeMatch = bookingDateTime.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥\s+(åˆå‰|åˆå¾Œ|å¤œé–“|ä¸€æ—¥)/);
                    if (!dateTimeMatch) {
                        console.warn('Could not parse booking_datetime:', bookingDateTime);
                        return;
                    }
                    
                    const [, year, month, day, timeSlot] = dateTimeMatch;
                    const date = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    
                    // Map time slot to slot ID
                    let slot;
                    switch (timeSlot) {
                        case 'åˆå‰': slot = 'morning'; break;
                        case 'åˆå¾Œ': slot = 'afternoon'; break;
                        case 'å¤œé–“': slot = 'night'; break;
                        case 'ä¸€æ—¥':
                            // ä¸€æ—¥ã®å ´åˆã¯ã‚µãƒ¼ãƒãƒ¼å´ã§æ—¢ã«åˆ†å‰²æ¸ˆã¿ãªã®ã§ã€
                            // å®Ÿéš›ã«ã¯ã“ã®ã‚±ãƒ¼ã‚¹ã¯ç™ºç”Ÿã—ãªã„ã¯ãš
                            console.warn('ä¸€æ—¥ãƒ‡ãƒ¼ã‚¿ãŒåˆ†å‰²ã•ã‚Œã¦ã„ã¾ã›ã‚“:', bookingDateTime);
                            return;
                        default: 
                            console.warn('Unknown time slot:', timeSlot);
                            return;
                    }
                    
                    // Find room config by roomId first (for split room handling), then fallback to CSV name
                    let roomConfig = config.rooms.find(r => r.id === booking.roomId);
                    if (!roomConfig) {
                        // Fallback to CSV name for compatibility
                        roomConfig = config.rooms.find(r => r.csv_name === booking['ä¼šè­°å®¤(äºˆç´„å†…å®¹)']);
                    }
                    if (!roomConfig) {
                        // æ–‡å­—æ­£è¦åŒ–ã§ãƒãƒƒãƒãƒ³ã‚°ã‚’è©¦è¡Œï¼ˆå…¨è§’ãƒ»åŠè§’æ•°å­—ã€æ‹¬å¼§ã®é•ã„ãªã©ï¼‰
                        const normalizedRoomName = booking['ä¼šè­°å®¤(äºˆç´„å†…å®¹)']
                            .replace(/[ï¼-ï¼™]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                            .replace(/ï¼ˆ/g, '(')
                            .replace(/ï¼‰/g, ')');
                        roomConfig = config.rooms.find(r => {
                            const normalizedConfigName = r.csv_name
                                .replace(/[ï¼-ï¼™]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                                .replace(/ï¼ˆ/g, '(')
                                .replace(/ï¼‰/g, ')');
                            return normalizedConfigName === normalizedRoomName;
                        });
                    }
                    if (!roomConfig) {
                        console.warn('Room not found in config:', booking['ä¼šè­°å®¤(äºˆç´„å†…å®¹)'], 'roomId:', booking.roomId);
                        // Room configãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã§ã‚‚ã€ãƒ€ãƒŸãƒ¼ã®è¨­å®šã§ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹
                        roomConfig = {
                            id: `unknown-${index}`,
                            csv_name: booking['ä¼šè­°å®¤(äºˆç´„å†…å®¹)'],
                            display_name: booking['ä¼šè­°å®¤(äºˆç´„å†…å®¹)']
                        };
                    }
                    
                    // Check if this is a special booking (either internal room or zero amount)
                    const isInternalRoom = config.internal_room_ids.includes(roomConfig.id);

                    // Check if payment amount is zero (æ”¯æ‰•é¡åˆè¨ˆãŒ0)
                    const paymentAmount = booking['æ”¯æ‰•é¡åˆè¨ˆ'] || booking['åˆè¨ˆé‡‘é¡(äºˆç´„å†…å®¹)'] || '0';
                    const isZeroPayment = parseFloat(paymentAmount.toString().replace(/[^\d.-]/g, '')) === 0;

                    const isSpecial = isInternalRoom || isZeroPayment;
                    
                    processedBookings.push({
                        id: `booking-${index}`,
                        date: date,
                        slot: slot,
                        roomId: roomConfig.id,
                        isSpecial: isSpecial,
                        'æ¡ˆå†…è¡¨ç¤ºå(äºˆç´„å†…å®¹)': booking['æ¡ˆå†…è¡¨ç¤ºå(äºˆç´„å†…å®¹)'] || '',
                        'äº‹æ¥­æ‰€å': booking['äº‹æ¥­æ‰€å'] || '',
                        'åˆ©ç”¨æ—¥æ™‚(äºˆç´„å†…å®¹)': booking['åˆ©ç”¨æ—¥æ™‚(äºˆç´„å†…å®¹)'] || '',
                        'ä¼šè­°å®¤(äºˆç´„å†…å®¹)': booking['ä¼šè­°å®¤(äºˆç´„å†…å®¹)'] || '',
                        'å»¶é•·(äºˆç´„å†…å®¹)': booking['å»¶é•·(äºˆç´„å†…å®¹)'] || '',
                        'å‚™å“(äºˆç´„å†…å®¹)': booking['å‚™å“(äºˆç´„å†…å®¹)'] || '',
                        'å‚™è€ƒï¼ˆã”è¦æœ›ã‚„æŒè¾¼æ©Ÿæãªã©ã”ã–ã„ã¾ã—ãŸã‚‰ã”å…¥åŠ›ãã ã•ã„ã€‚ï¼‰': booking['å‚™è€ƒï¼ˆã”è¦æœ›ã‚„æŒè¾¼æ©Ÿæãªã©ã”ã–ã„ã¾ã—ãŸã‚‰ã”å…¥åŠ›ãã ã•ã„ã€‚ï¼‰'] || '',
                        'ãƒ¡ãƒ¢': booking['ãƒ¡ãƒ¢'] || '',
                        'åˆ©ç”¨ç›®çš„(äºˆç´„å†…å®¹)': booking['åˆ©ç”¨ç›®çš„(äºˆç´„å†…å®¹)'] || '',
                        'ä¼šå“¡ç¨®åˆ¥(äºˆç´„å†…å®¹)': booking['ä¼šå“¡ç¨®åˆ¥(äºˆç´„å†…å®¹)'] || '',
                        'éƒ¨ç½²å': booking['éƒ¨ç½²å'] || '',
                        'æ‹…å½“è€…å': booking['æ‹…å½“è€…å'] || '',
                        'éƒµä¾¿ç•ªå·': booking['éƒµä¾¿ç•ªå·'] || '',
                        'æ”¯æ‰•é¡åˆè¨ˆ': booking['æ”¯æ‰•é¡åˆè¨ˆ'] || '',
                        'åˆè¨ˆé‡‘é¡(äºˆç´„å†…å®¹)': booking['åˆè¨ˆé‡‘é¡(äºˆç´„å†…å®¹)'] || ''
                    });
                });

                // Apply data split rules
                const finalBookings = applyDataSplitRules(processedBookings, config);

                return finalBookings;
            }

            // Apply data split rules to create additional bookings for split rooms
            function applyDataSplitRules(bookings, config) {
                const splitRules = config.data_split_rules || [];
                const splitBookings = [...bookings]; // Copy original bookings

                splitRules.forEach(rule => {
                    // Skip disabled rules
                    if (!rule.enabled) return;

                    // Find bookings for the source room
                    const sourceBookings = bookings.filter(booking =>
                        booking.roomId === rule.source_room_id
                    );

                    // Create split bookings for each target room
                    sourceBookings.forEach(sourceBooking => {
                        rule.target_room_ids.forEach(targetRoomId => {
                            // Skip if target room doesn't exist in config
                            const targetRoom = config.rooms.find(r => r.id === targetRoomId);
                            if (!targetRoom) {
                                console.warn(`Target room not found: ${targetRoomId}`);
                                return;
                            }

                            // Create a copy of the booking for the target room
                            const splitBooking = {
                                ...sourceBooking,
                                id: `${sourceBooking.id}-split-${targetRoomId}`,
                                roomId: targetRoomId,
                                // Update room name in the booking details
                                'ä¼šè­°å®¤(äºˆç´„å†…å®¹)': targetRoom.csv_name || targetRoom.display_name,
                                // Mark as split booking for identification
                                isSplitBooking: true,
                                originalRoomId: rule.source_room_id
                            };

                            splitBookings.push(splitBooking);
                        });
                    });
                });

                console.log(`Applied ${splitRules.length} split rules. Original: ${bookings.length}, Final: ${splitBookings.length}`);
                return splitBookings;
            }

            // --- Initialization ---
            async function initialize() {
                try {
                    // Fetch config first
                    const configResponse = await fetch(CONFIG_URL);
                    if (!configResponse.ok) throw new Error('Failed to load config.json');
                    const config = await configResponse.json();
                    
                    // Process config
                    rooms = config.rooms.reduce((acc, room) => {
                        acc[room.id] = room.display_name;
                        return acc;
                    }, {});
                    internalRoomIds = config.internal_room_ids || [];
                    // âœ¨ é †åºä»˜ããƒªã‚¹ãƒˆå½¢å¼ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨ï¼ˆæ–°å½¢å¼ï¼‰
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå¾“æ¥ã®è¾æ›¸å½¢å¼ã‚’ä½¿ç”¨
                    if (config.modal_fields_list && Array.isArray(config.modal_fields_list)) {
                        // æ–°å½¢å¼ï¼šãƒªã‚¹ãƒˆå½¢å¼ã§é †åºã‚’ä¿æŒ
                        modalFields = config.modal_fields_list;
                    } else {
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šè¾æ›¸å½¢å¼ã‚’äº’æ›å½¢å¼ã«å¤‰æ›
                        const fieldsDict = config.modal_fields || {};
                        modalFields = Object.entries(fieldsDict).map(([display_name, csv_field]) => ({
                            display_name,
                            csv_field
                        }));
                    }
                    
                    // Filter out hidden rooms from display
                    const hiddenRoomIds = config.hidden_room_ids || [];
                    filteredRooms = Object.keys(rooms).filter(roomId => !hiddenRoomIds.includes(roomId));

                    renderRoomFilter();

                    // Fetch bookings
                    const bookingsResponse = await fetch(API_URL);
                    if (!bookingsResponse.ok) throw new Error(`HTTP error! status: ${bookingsResponse.status}`);
                    const rawBookings = await bookingsResponse.json();
                    
                    // Process bookings data
                    bookings = parseBookingData(rawBookings, config);
                    console.log('Processed bookings:', bookings);
                    
                    render();
                } catch (error) {
                    console.error("Initialization failed:", error);
                    loadingEl.textContent = `åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
                }
            }

            // --- Search Functions ---
            function performSearch(searchTerm) {
                if (!searchTerm || searchTerm.trim().length < 2) {
                    exitSearchMode();
                    return;
                }

                const term = searchTerm.toLowerCase().trim();
                const results = bookings.filter(booking => {
                    return Object.values(booking).some(value =>
                        String(value).toLowerCase().includes(term)
                    );
                });

                searchResultsData = results.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateA - dateB;
                });

                searchMode = true;
                searchClearBtn.classList.remove('hidden');
                searchResultsCount.classList.remove('hidden');
                searchResultsCount.textContent = `${searchResultsData.length}ä»¶ã®çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;

                render();
            }

            function renderSearchResults() {
                calendarContainer.classList.add('hidden');
                searchResultsContainer.classList.remove('hidden');

                if (searchResultsData.length === 0) {
                    searchResultsEl.innerHTML = '<div class="text-gray-500 text-center py-8">è©²å½“ã™ã‚‹äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
                    return;
                }

                const html = searchResultsData.map((booking, index) => {
                    const dateObj = new Date(booking.date);
                    const weekDay = dateObj.toLocaleDateString('ja-JP', { weekday: 'short' });
                    const formattedDate = `${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥(${weekDay})`;

                    const displayName = booking['æ¡ˆå†…è¡¨ç¤ºå(äºˆç´„å†…å®¹)'] || 'åç§°æœªè¨­å®š';
                    const companyName = booking['äº‹æ¥­æ‰€å'] || '';
                    const contactPerson = booking['æ‹…å½“è€…å'] || '';
                    const roomName = rooms[booking.roomId] || booking['ä¼šè­°å®¤(äºˆç´„å†…å®¹)'];
                    const slotName = booking.slot === 'morning' ? 'åˆå‰' : booking.slot === 'afternoon' ? 'åˆå¾Œ' : 'å¤œé–“';
                    const isSpecial = booking.isSpecial;

                    const specialClass = isSpecial ? 'border-yellow-300 bg-yellow-50' : 'border-blue-300 bg-blue-50';

                    return `
                        <div class="border-2 ${specialClass} rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow search-result-item"
                             data-booking-id="${booking.id}">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-lg">${displayName}</h4>
                                <span class="text-sm px-2 py-1 ${isSpecial ? 'bg-yellow-200 text-yellow-800' : 'bg-blue-200 text-blue-800'} rounded">
                                    ${isSpecial ? 'ç„¡æ–™è²¸å‡º' : 'æœ‰æ–™è²¸å‡º'}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                                <div><strong>æ—¥æ™‚:</strong> ${formattedDate}</div>
                                <div><strong>ä¼šè­°å®¤:</strong> ${roomName}</div>
                                <div><strong>æ™‚é–“å¸¯:</strong> ${slotName}</div>
                                <div><strong>äº‹æ¥­æ‰€:</strong> ${companyName}</div>
                                ${contactPerson ? `<div class="col-span-2"><strong>æ‹…å½“è€…:</strong> ${contactPerson}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                searchResultsEl.innerHTML = html;

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                searchResultsEl.querySelectorAll('.search-result-item').forEach((item, index) => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const bookingId = item.dataset.bookingId;
                        const booking = searchResultsData[index];
                        console.log('Search result clicked, booking ID:', bookingId);
                        console.log('Search result booking data:', booking);
                        showBookingDetailsFromSearch(booking);
                    });
                });
            }

            function exitSearchMode() {
                searchMode = false;
                searchResultsData = [];
                searchInput.value = '';
                searchClearBtn.classList.add('hidden');
                searchResultsCount.classList.add('hidden');
                searchResultsContainer.classList.add('hidden');
                calendarContainer.classList.remove('hidden');
                render();
            }

            // --- State Management ---
            function moveDate(direction) {
                if (currentView === 'month') {
                    currentDate.setMonth(currentDate.getMonth() + direction);
                } else if (currentView === 'week') {
                    currentDate.setDate(currentDate.getDate() + 7 * direction);
                } else {
                    currentDate.setDate(currentDate.getDate() + direction);
                }
                render();
            }

            function showToday() {
                currentDate = new Date();
                render();
            }

            function setView(view) {
                currentView = view;
                render();
            }

            function showDayView(dateStr) {
                const parts = dateStr.split('-');
                currentDate = new Date(parts[0], parts[1] - 1, parts[2]);
                setView('day');
            }

            function updateFilteredRooms() {
                filteredRooms = Array.from(roomFilterEl.querySelectorAll('input:checked')).map(input => input.value);
                render();
            }

            function showBookingDetails(bookingId) {
                console.log('showBookingDetails called with:', bookingId);
                console.log('Available bookings:', bookings);
                const booking = bookings.find(b => b.id === bookingId);
                console.log('Found booking:', booking);
                if (!booking) {
                    console.error('Booking not found for ID:', bookingId);
                    return;
                }

                let detailsHtml = '<dl class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2">';

                // âœ¨ è¨­å®šã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§è¨­å®šã•ã‚ŒãŸmodalFieldsã‚’ä½¿ç”¨ï¼ˆé †åºä»˜ãï¼‰
                const fieldsOrder = Array.isArray(modalFields)
                    ? modalFields
                    : Object.entries(modalFields).map(([label, key]) => ({ display_name: label, csv_field: key }));

                for (const fieldItem of fieldsOrder) {
                    const label = fieldItem.display_name;
                    const key = fieldItem.csv_field;
                    let value = booking[key] || ''; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºæ–‡å­—
                    
                    if (label === 'åˆ©ç”¨æ—¥æ™‚' && booking.date) {
                        const dateParts = booking.date.split('-');
                        const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                        const weekDay = dateObj.toLocaleDateString('ja-JP', { weekday: 'short' });
                        value = `${value} (${weekDay})`;
                    }

                    if (key === 'å‚™å“(äºˆç´„å†…å®¹)' && typeof value === 'string' && value.length > 1) {
                        let cleanedValue = value.substring(1, value.length - 1);
                        const items = cleanedValue.split(/\]\s*,\s*\[/);
                        const processedItems = items.map(item => {
                            const parts = item.split('ï¼š');
                            if (parts.length > 2) {
                                return parts.slice(0, 2).join('ï¼š');
                            }
                            return item;
                        });
                        value = processedItems.join('<br>');
                    }

                    detailsHtml += `
                        <dt class="font-bold text-gray-600 md:col-span-1">${label}</dt>
                        <dd class="text-gray-800 md:col-span-2">${value}</dd>
                    `;
                }
                detailsHtml += '</dl>';

                modalBody.innerHTML = detailsHtml;
                modal.style.display = 'block';
            }

            function showBookingDetailsFromSearch(booking) {
                console.log('showBookingDetailsFromSearch called with:', booking);
                if (!booking) {
                    console.error('No booking data provided');
                    return;
                }

                let detailsHtml = '<dl class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2">';

                // âœ¨ è¨­å®šã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§è¨­å®šã•ã‚ŒãŸmodalFieldsã‚’ä½¿ç”¨ï¼ˆé †åºä»˜ãï¼‰
                const fieldsOrder = Array.isArray(modalFields)
                    ? modalFields
                    : Object.entries(modalFields).map(([label, key]) => ({ display_name: label, csv_field: key }));

                for (const fieldItem of fieldsOrder) {
                    const label = fieldItem.display_name;
                    const key = fieldItem.csv_field;
                    let value = booking[key] || ''; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºæ–‡å­—
                    
                    if (label === 'åˆ©ç”¨æ—¥æ™‚' && booking.date) {
                        const dateParts = booking.date.split('-');
                        const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                        const weekDay = dateObj.toLocaleDateString('ja-JP', { weekday: 'short' });
                        value = `${value} (${weekDay})`;
                    }

                    if (key === 'å‚™å“(äºˆç´„å†…å®¹)' && typeof value === 'string' && value.length > 1) {
                        let cleanedValue = value.substring(1, value.length - 1);
                        const items = cleanedValue.split(/\]\s*,\s*\[/);
                        const processedItems = items.map(item => {
                            const parts = item.split('ï¼š');
                            if (parts.length > 2) {
                                return parts.slice(0, 2).join('ï¼š');
                            }
                            return item;
                        });
                        value = processedItems.join('<br>');
                    }

                    detailsHtml += `
                        <dt class="font-bold text-gray-600 md:col-span-1">${label}</dt>
                        <dd class="text-gray-800 md:col-span-2">${value}</dd>
                    `;
                }
                detailsHtml += '</dl>';

                modalBody.innerHTML = detailsHtml;
                modal.style.display = 'block';
            }

            function toYYYYMMDD(date) {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            }

            // --- Rendering ---
            function render() {
                if (searchMode) {
                    renderSearchResults();
                } else {
                    loadingEl.style.display = 'none';
                    updateCurrentPeriod();
                    if (currentView === 'month') {
                        renderMonthView();
                    } else if (currentView === 'week') {
                        renderWeekView();
                    } else {
                        renderDayView();
                    }
                }
            }

            function renderRoomFilter() {
                // Only show rooms that are not hidden
                roomFilterEl.innerHTML = filteredRooms.map(id => `
                    <label class="flex items-center ${internalRoomIds.includes(id) ? 'internal-room p-1 rounded' : ''}">
                        <input type="checkbox" value="${id}" checked class="mr-2">
                        ${rooms[id]} ${internalRoomIds.includes(id) ? '(å†…éƒ¨ç”¨)' : ''}
                    </label>
                `).join('');
                roomFilterEl.querySelectorAll('input').forEach(input => {
                    input.addEventListener('change', updateFilteredRooms);
                });
            }

            function updateCurrentPeriod() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                const day = currentDate.getDate();
                const weekDay = currentDate.toLocaleDateString('ja-JP', { weekday: 'short' });

                if (currentView === 'month') {
                    currentPeriodEl.textContent = `${year}å¹´${month}æœˆ`;
                } else if (currentView === 'week') {
                    const startOfWeek = new Date(currentDate);
                    // æœˆæ›œå§‹ã¾ã‚Šã«å¤‰æ›´ï¼š(getDay() + 6) % 7
                    startOfWeek.setDate(startOfWeek.getDate() - ((startOfWeek.getDay() + 6) % 7));
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(endOfWeek.getDate() + 6);
                    currentPeriodEl.textContent = `${startOfWeek.getFullYear()}å¹´${startOfWeek.getMonth() + 1}æœˆ${startOfWeek.getDate()}æ—¥(${startOfWeek.toLocaleDateString('ja-JP', { weekday: 'short' })}) - ${endOfWeek.getFullYear()}å¹´${endOfWeek.getMonth() + 1}æœˆ${endOfWeek.getDate()}æ—¥(${endOfWeek.toLocaleDateString('ja-JP', { weekday: 'short' })})`;
                } else {
                    currentPeriodEl.textContent = `${year}å¹´${month}æœˆ${day}æ—¥(${weekDay})`;
                }
            }

            function getBookingsFor(date, roomId, slot) {
                const dateStr = toYYYYMMDD(date);
                return bookings.filter(b => 
                    b.date === dateStr && 
                    b.slot === slot &&
                    b.roomId === roomId
                );
            }

            // --- View Renderers ---
            function renderMonthView() {
                let html = '<table class="w-full border-collapse"><thead><tr>';
                const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
                days.forEach(day => html += `<th class="border p-2">${day}</th>`);
                html += '</tr></thead><tbody>';

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                // æœˆæ›œå§‹ã¾ã‚Šã«å¤‰æ›´ï¼šgetDay()ã§æ—¥æ›œ=0ãªã®ã§ã€æœˆæ›œå§‹ã¾ã‚Šã«ã™ã‚‹ã«ã¯(getDay() + 6) % 7
                startDate.setDate(startDate.getDate() - ((firstDay.getDay() + 6) % 7));

                let currentDatePointer = new Date(startDate);

                for (let i = 0; i < 6; i++) {
                    html += '<tr>';
                    for (let j = 0; j < 7; j++) {
                        const isCurrentMonth = currentDatePointer.getMonth() === month;
                        const dateStr = toYYYYMMDD(currentDatePointer);
                        const isToday = toYYYYMMDD(new Date()) === dateStr;
                        const cellClass = isCurrentMonth ? (isToday ? 'today-highlight cursor-pointer hover:bg-pink-200' : 'bg-white cursor-pointer hover:bg-blue-100') : 'bg-gray-50';
                        html += `<td class="border p-2 align-top ${cellClass}" data-date="${dateStr}">
                            <div class="font-bold ${isCurrentMonth ? 'text-black' : 'text-gray-400'}">${currentDatePointer.getDate()}</div>`;

                        if (isCurrentMonth) {
                            html += `<div class="grid grid-cols-3 gap-1 text-xs text-center mt-1">
                                        <div class="font-bold">åˆå‰</div>
                                        <div class="font-bold">åˆå¾Œ</div>
                                        <div class="font-bold">å¤œé–“</div>
                                    </div>`;

                            filteredRooms.forEach(roomId => {
                                const morningBookings = getBookingsFor(currentDatePointer, roomId, 'morning');
                                const afternoonBookings = getBookingsFor(currentDatePointer, roomId, 'afternoon');
                                const nightBookings = getBookingsFor(currentDatePointer, roomId, 'night');

                                const isMorningBooked = morningBookings.length > 0;
                                const isAfternoonBooked = afternoonBookings.length > 0;
                                const isNightBooked = nightBookings.length > 0;

                                const isMorningSpecial = isMorningBooked && morningBookings[0].isSpecial;
                                const isAfternoonSpecial = isAfternoonBooked && afternoonBookings[0].isSpecial;
                                const isNightSpecial = isNightBooked && nightBookings[0].isSpecial;

                                const morningClass = isMorningSpecial ? 'special-booking' : (isMorningBooked ? 'bg-blue-500 text-white' : '');
                                const afternoonClass = isAfternoonSpecial ? 'special-booking' : (isAfternoonBooked ? 'bg-blue-500 text-white' : '');
                                const nightClass = isNightSpecial ? 'special-booking' : (isNightBooked ? 'bg-blue-500 text-white' : '');

                                html += `<div class="grid grid-cols-3 gap-1 text-xs text-center mt-0.5">
                                            <div class="${morningClass} p-0.5 rounded">${isMorningBooked ? rooms[roomId] : ''}</div>
                                            <div class="${afternoonClass} p-0.5 rounded">${isAfternoonBooked ? rooms[roomId] : ''}</div>
                                            <div class="${nightClass} p-0.5 rounded">${isNightBooked ? rooms[roomId] : ''}</div>
                                        </div>`;
                            });
                        }
                        
                        html += '</td>';
                        currentDatePointer.setDate(currentDatePointer.getDate() + 1);
                    }
                    html += '</tr>';
                    if (currentDatePointer > lastDay && i > 3) break;
                }

                html += '</tbody></table>';
                calendarEl.innerHTML = html;

                calendarEl.querySelectorAll('td[data-date]').forEach(cell => {
                    cell.addEventListener('click', () => {
                        showDayView(cell.dataset.date);
                    });
                });
            }

            function renderWeekView() {
                let html = '<table class="w-full border-collapse"><thead><tr><th class="border p-2">ä¼šè­°å®¤</th>';
                const slots = { morning: 'åˆå‰', afternoon: 'åˆå¾Œ', night: 'å¤œé–“' };
                const startOfWeek = new Date(currentDate);
                // æœˆæ›œå§‹ã¾ã‚Šã«å¤‰æ›´ï¼š(getDay() + 6) % 7
                startOfWeek.setDate(startOfWeek.getDate() - ((startOfWeek.getDay() + 6) % 7));

                for (let i = 0; i < 7; i++) {
                    const day = new Date(startOfWeek);
                    day.setDate(day.getDate() + i);
                    const dateStr = toYYYYMMDD(day);
                    const weekDay = day.toLocaleDateString('ja-JP', { weekday: 'short' });
                    const isToday = toYYYYMMDD(new Date()) === dateStr;
                    const headerClass = isToday ? 'today-highlight cursor-pointer hover:bg-pink-200' : 'cursor-pointer hover:bg-blue-100';
                    html += `<th class="border p-2 ${headerClass}" data-date="${dateStr}">${day.getMonth() + 1}/${day.getDate()} (${weekDay})</th>`;
                }
                html += '</tr></thead><tbody>';

                filteredRooms.forEach(roomId => {
                    html += `<tr><td class="border p-2 font-bold ${internalRoomIds.includes(roomId) ? 'internal-room' : ''}">${rooms[roomId]}</td>`;
                    for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek);
                        day.setDate(day.getDate() + i);
                        const dateStr = toYYYYMMDD(day);
                        const isToday = toYYYYMMDD(new Date()) === toYYYYMMDD(day);
                        const cellClass = isToday ? 'today-highlight cursor-pointer hover:bg-pink-200' : 'cursor-pointer hover:bg-blue-100';
                        html += `<td class="border p-2 align-top ${cellClass}" data-date="${dateStr}">`;
                        Object.entries(slots).forEach(([slotId, slotName]) => {
                            const bookingsInSlot = getBookingsFor(day, roomId, slotId);
                            const isBooked = bookingsInSlot.length > 0;
                            const purpose = isBooked ? (bookingsInSlot[0]['æ¡ˆå†…è¡¨ç¤ºå(äºˆç´„å†…å®¹)'] || 'åç§°æœªè¨­å®š') : 'ç©ºã';
                            
                            let cellClass = 'bg-gray-300';
                            if (isBooked) {
                                if (bookingsInSlot[0].isSpecial) {
                                    cellClass = 'special-booking';
                                } else {
                                    cellClass = 'bg-blue-500 text-white';
                                }
                            }
                            html += `<div class="p-1 my-1 rounded text-xs text-center ${cellClass}">${slotName}: ${purpose}</div>`;
                        });
                        html += '</td>';
                    }
                    html += '</tr>';
                });

                html += '</tbody></table>';
                calendarEl.innerHTML = html;

                calendarEl.querySelectorAll('th[data-date]').forEach(header => {
                    header.addEventListener('click', () => {
                        showDayView(header.dataset.date);
                    });
                });

                // é€±è¡¨ç¤ºã®æ—¥ä»˜åˆ—ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§æ—¥è¡¨ç¤ºã«é·ç§»
                calendarEl.querySelectorAll('td[data-date]').forEach(cell => {
                    cell.addEventListener('click', () => {
                        showDayView(cell.dataset.date);
                    });
                });
            }

            function renderDayView() {
                let html = '<table class="w-full border-collapse"><thead><tr><th class="border p-2">ä¼šè­°å®¤</th><th class="border p-2">åˆå‰</th><th class="border p-2">åˆå¾Œ</th><th class="border p-2">å¤œé–“</th></tr></thead><tbody>';
                const slots = { morning: 'åˆå‰', afternoon: 'åˆå¾Œ', night: 'å¤œé–“' };

                filteredRooms.forEach(roomId => {
                    html += `<tr><td class="border p-2 font-bold ${internalRoomIds.includes(roomId) ? 'internal-room' : ''}">${rooms[roomId]}</td>`;
                    Object.entries(slots).forEach(([slotId, slotName]) => {
                        const bookingsInSlot = getBookingsFor(currentDate, roomId, slotId);
                        const isBooked = bookingsInSlot.length > 0;
                        if (isBooked) {
                            const booking = bookingsInSlot[0];
                            const purpose = `${booking['æ¡ˆå†…è¡¨ç¤ºå(äºˆç´„å†…å®¹)'] || ''} (${booking['äº‹æ¥­æ‰€å'] || ''})`;
                            
                            let cellClass = '';
                            if (booking.isSpecial) {
                                cellClass = 'special-booking';
                            } else {
                                cellClass = 'bg-blue-500 text-white';
                            }
                            html += `<td class="border p-2 text-center cursor-pointer hover:bg-yellow-100 ${cellClass}" data-booking-id="${booking.id}">${purpose}</td>`;
                        } else {
                            html += `<td class="border p-2 text-center bg-gray-300">ç©ºã</td>`;
                        }
                    });
                    html += '</tr>';
                });

                html += '</tbody></table>';
                calendarEl.innerHTML = html;

                calendarEl.querySelectorAll('td[data-booking-id]').forEach(cell => {
                    cell.addEventListener('click', () => {
                        showBookingDetails(cell.dataset.bookingId);
                    });
                });
            }

            // --- Auto-refresh ---
            // è‡ªå‹•æ›´æ–°ã¯ä¸è¦ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ä¸€æ—¥ä¸€å›ç¨‹åº¦ã®ãŸã‚ï¼‰
            // setInterval(initialize, 30000); // 30ç§’ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—

            // --- ç®¡ç†æ©Ÿèƒ½ ---
            const serverStatusEl = document.getElementById('server-status');
            const serverInfoEl = document.getElementById('server-info');
            const fileStatusEl = document.getElementById('file-status');
            const adminMessageEl = document.getElementById('admin-message');

            function showAdminMessage(message, isError = false) {
                adminMessageEl.textContent = message;
                adminMessageEl.className = `text-sm p-2 rounded ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
                adminMessageEl.classList.remove('hidden');
                setTimeout(() => {
                    adminMessageEl.classList.add('hidden');
                }, 3000);
            }

            async function updateServerStatus() {
                try {
                    const response = await fetch('/api/status');
                    if (response.ok) {
                        const status = await response.json();
                        serverStatusEl.textContent = 'èµ·å‹•ä¸­';
                        serverStatusEl.className = 'px-2 py-1 text-xs rounded bg-green-200 text-green-800';
                        const uptime = Math.floor(status.uptime / 60);
                        serverInfoEl.textContent = `ç¨¼åƒæ™‚é–“: ${uptime}åˆ† | æœ€çµ‚æ›´æ–°: ${status.timestamp}`;
                    } else {
                        throw new Error('Status check failed');
                    }
                } catch (error) {
                    serverStatusEl.textContent = 'ä¸æ˜';
                    serverStatusEl.className = 'px-2 py-1 text-xs rounded bg-yellow-200 text-yellow-800';
                    serverInfoEl.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼';
                }
            }

            async function updateFileStatus() {
                try {
                    const response = await fetch('/api/files-info');
                    if (response.ok) {
                        const info = await response.json();
                        let statusHtml = '';
                        statusHtml += `<div>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: ${info.config_exists ? 'âœ…' : 'âŒ'}</div>`;
                        statusHtml += `<div>äºˆç´„ãƒ‡ãƒ¼ã‚¿: ${info.bookings_csv_exists ? 'âœ…' : 'âŒ'}</div>`;
                        statusHtml += `<div>æœªå‡¦ç†CSV: ${info.uploads_count}ä»¶</div>`;
                        statusHtml += `<div>å‡¦ç†æ¸ˆ: ${info.processed_count}ä»¶</div>`;
                        fileStatusEl.innerHTML = statusHtml;
                    }
                } catch (error) {
                    fileStatusEl.innerHTML = '<div>ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼</div>';
                }
            }

            // ç®¡ç†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('open-config-btn').addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/open-config');
                    const result = await response.json();
                    showAdminMessage(result.message, !result.success);
                } catch (error) {
                    showAdminMessage('è¨­å®šã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼èµ·å‹•ã‚¨ãƒ©ãƒ¼', true);
                }
            });


            document.getElementById('refresh-status-btn').addEventListener('click', () => {
                updateServerStatus();
                updateFileStatus();
                showAdminMessage('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            });

            document.getElementById('stop-server-btn').addEventListener('click', async () => {
                if (confirm('ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ\nåœæ­¢å¾Œã¯æ‰‹å‹•ã§å†èµ·å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚')) {
                    try {
                        const response = await fetch('/api/server-control', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'stop' })
                        });
                        const result = await response.json();
                        showAdminMessage(result.message, !result.success);
                        if (result.success) {
                            setTimeout(() => {
                                serverStatusEl.textContent = 'åœæ­¢ä¸­';
                                serverStatusEl.className = 'px-2 py-1 text-xs rounded bg-red-200 text-red-800';
                                serverInfoEl.textContent = 'ã‚µãƒ¼ãƒãƒ¼ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸ';
                            }, 1000);
                        }
                    } catch (error) {
                        showAdminMessage('ã‚µãƒ¼ãƒãƒ¼åœæ­¢ã‚¨ãƒ©ãƒ¼', true);
                    }
                }
            });

            // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            updateServerStatus();
            updateFileStatus();

            // å®šæœŸçš„ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã¯ä¸è¦ï¼ˆæ‰‹å‹•æ›´æ–°ã§ååˆ†ï¼‰
            // setInterval(() => {
            //     updateServerStatus();
            //     updateFileStatus();
            // }, 10000); // 10ç§’ã”ã¨

            initialize();
        });
    </script>
</body>
</html>
